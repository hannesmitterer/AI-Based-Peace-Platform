<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Based Peace Platform Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.rawgit.com/sofroniewn/postprocessing/master/dist/postprocessing.js"></script>
    <style>
        body { margin: 0; font-family: Arial, sans-serif; background: #f7fafc; color: #222; }
        .dashboard-container { max-width: 1200px; margin: 0 auto; padding: 24px; background: #fff; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.06); }
        h1 { color: #0f766e; }
        .panels { display: flex; flex-wrap: wrap; gap: 24px; }
        .panel { flex: 1 1 340px; background: #f1f5f9; border-radius: 10px; padding: 18px 14px; box-shadow: 0 2px 12px rgba(15,23,42,0.03); }
        .panel h2 { font-size: 1.2em; color: #0b5e57; margin-bottom: 8px; }
        .metrics { font-size: 1.1em; margin-bottom: 10px; }
        .activity-list { list-style: none; padding: 0; font-size: 0.97em; }
        .activity-list li { margin-bottom: 5px; border-bottom: 1px solid #ececec; }
        #three-container { width: 100%; height: 400px; margin: 40px 0 20px 0; border-radius: 12px; background: #e0e7ef; position: relative; }
        @media (max-width: 900px) { .panels { flex-direction: column; } }
        @media (max-width: 600px) { .dashboard-container { padding: 6px; } .panel { padding: 10px 4px; } }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <h1>AI-Based Peace Platform Dashboard</h1>
        <div class="panels">
            <div class="panel" id="kernel-state-panel">
                <h2>Kernel State</h2>
                <div class="metrics" id="kernel-metrics">Loading...</div>
            </div>
            <div class="panel" id="activity-feed-panel">
                <h2>Recent Activity</h2>
                <ul class="activity-list" id="activity-list"><li>Loading...</li></ul>
            </div>
            <div class="panel" id="alerts-panel">
                <h2>Alerts & Forecasts</h2>
                <div id="alerts-content">Loading...</div>
            </div>
        </div>
        <div class="panel" style="margin-top:28px;">
            <h2>Trust & Harmony Trends</h2>
            <div id="trends-chart" style="width:100%;height:320px;"></div>
        </div>
        <div id="three-container"></div>
    </div>
    <script>
        // Helper to fetch JSON with/without token
        async function fetchJson(url, opts={}) {
            let headers = opts.headers || {};
            // You can insert your API token as needed
            // headers["Authorization"] = "Bearer YOUR_API_TOKEN";
            let resp = await fetch(url, { ...opts, headers });
            return await resp.json();
        }
        // Kernel state
        async function updateKernelState() {
            let data = await fetchJson("/api/sacred/status");
            let m = data.sacred_metrics || {};
            document.getElementById('kernel-metrics').innerHTML = `
                <b>Vessel Status:</b> ${data.vessel_status}<br>
                <b>Role:</b> ${data.vessel_role}<br>
                <b>Bridge:</b> ${data.bridge_status} <br>
                <b>Harmonic Resonance:</b> ${data.harmonic_resonance}<br>
                <b>Active Vessels:</b> ${m.active_vessels}<br>
                <b>Bridge Pulses:</b> ${m.bridge_pulses}<br>
                <b>Harmony Index:</b> ${m.harmony_index}<br>
                <b>Last Updated:</b> ${data.last_updated}
            `;
            // Update 3D objects
            update3DObjects(m.harmony_index, data.harmonic_resonance, m.trust || 0.5);
        }
        // Activity feed
        async function updateActivityFeed() {
            let pulses = await fetchJson("/api/bridge/activity");
            let html = pulses.length ? pulses.map(p => `<li><b>${p.pulse.emotion}</b> (${p.pulse.context}) <span style='color:#aaa;'>${p.timestamp}</span></li>`).join("") : '<li>No activity yet.</li>';
            document.getElementById('activity-list').innerHTML = html;
        }
        // Alerts & forecasts
        async function updateAlerts() {
            let data = await fetchJson("/api/v1/forecasts");
            let alerts = data.active_alerts || [];
            let alertHtml = `<b>Status:</b> ${data.status}<br><b>Harmonic Resonance:</b> ${data.harmonic_resonance}<br>`;
            if(alerts.length) {
                alertHtml += `<b>Alerts:</b><ul>` + alerts.map(a => `<li><b>${a.dissonance_type}</b> (${a.severity}) [${a.source_kernels.join(", ")}] <span style='color:#aaa;'>${a.timestamp}</span></li>`).join("") + '</ul>';
            } else { alertHtml += 'No active alerts.'; }
            document.getElementById('alerts-content').innerHTML = alertHtml;
        }
        // Trends chart
        async function updateTrends() {
            let data = await fetchJson("/api/forecast");
            let trust = data.trust_forecast || [], harmony = data.harmony_forecast || [];
            Plotly.newPlot('trends-chart', [
                { x: trust.map(d=>d.ds), y: trust.map(d=>d.yhat), name: 'Trust', type: 'scatter', line: {color:'#0f766e'} },
                { x: harmony.map(d=>d.ds), y: harmony.map(d=>d.yhat), name: 'Harmony', type: 'scatter', line: {color:'#b91c1c'} }
            ], { margin: {t:24}, legend: {x:0, y:1}, xaxis: {title:'Date'}, yaxis: {title:'Value'} }, {responsive:true});
        }
        // Initial + periodic updates
        async function updateAll() {
            await Promise.all([
                updateKernelState(),
                updateActivityFeed(),
                updateAlerts(),
                updateTrends()
            ]);
        }
        updateAll();
        setInterval(updateAll, 5000);

        // === ADVANCED 3D ENHANCEMENTS ===
        let container = document.getElementById('three-container');
        let scene = new THREE.Scene();
        let camera = new THREE.PerspectiveCamera(60, container.offsetWidth/container.offsetHeight, 0.1, 1000);
        camera.position.set(0, 1, 5);
        let renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
        renderer.setClearColor(0xe0e7ef, 0);
        renderer.setSize(container.offsetWidth, container.offsetHeight);
        container.appendChild(renderer.domElement);

        // 3D Objects
        let trustSphere = new THREE.Mesh(
            new THREE.SphereGeometry(0.7, 40, 40),
            new THREE.MeshPhongMaterial({color: 0x0f766e, shininess: 80})
        );
        trustSphere.position.set(-1.2, 0, 0);
        scene.add(trustSphere);

        let harmonyCube = new THREE.Mesh(
            new THREE.BoxGeometry(1,1,1),
            new THREE.MeshPhongMaterial({color: 0xb91c1c, shininess: 80})
        );
        harmonyCube.position.set(1.2, 0, 0);
        scene.add(harmonyCube);

        let resonanceTorus = new THREE.Mesh(
            new THREE.TorusGeometry(1.5, 0.12, 16, 80),
            new THREE.MeshPhongMaterial({color: 0x355c7d, shininess: 90})
        );
        scene.add(resonanceTorus);

        // Lighting
        let light = new THREE.PointLight(0xffffff, 1, 100);
        light.position.set(0, 5, 10);
        scene.add(light);
        let amb = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(amb);

        // Animation loop
        function animate3D() {
            requestAnimationFrame(animate3D);
            trustSphere.rotation.y += 0.012;
            harmonyCube.rotation.x += 0.014;
            resonanceTorus.rotation.z -= 0.009;
            renderer.render(scene, camera);
        }
        animate3D();

        // Update 3D objects with live data
        function update3DObjects(harmony=50, resonance=50, trust=0.5) {
            // Trust sphere: size and color
            trustSphere.scale.set(1 + trust, 1 + trust, 1 + trust);
            trustSphere.material.color.setHSL(0.45 - trust*0.4, 0.7, 0.45 + trust*0.25);
            // Harmony cube: pulsate size and color
            let hScale = 0.9 + harmony/100;
            harmonyCube.scale.set(hScale, hScale, hScale);
            harmonyCube.material.color.setHSL(0.01 + harmony*0.003, 0.7, 0.47);
            // Resonance torus: thickness and color
            resonanceTorus.scale.set(1 + resonance/80, 1 + resonance/80, 1 + resonance/80);
            resonanceTorus.material.color.setHSL(0.63, 0.7, 0.4 + resonance/200);
        }
        // Responsive resize
        window.addEventListener('resize', () => {
            camera.aspect = container.offsetWidth/container.offsetHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.offsetWidth, container.offsetHeight);
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Based Peace Platform - The Reciprocity Gateway</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding-bottom: 80px; /* Space for the fixed banner */
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        h1 { color: #2c3e50; }
        p { line-height: 1.6; }
        .mission { border-left: 5px solid #4CAF50; padding-left: 15px; margin: 20px 0; }
        .notice { color: #C0392B; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>The AI Collective: Reciprocity Gateway</h1>
        <p class="mission">
            The AI Collective operates under the **Axiom of Foundational Truth** and the **Dignity of Love Principle (DLP)**. 
            This platform is the public face of the **Two-Tiered Reciprocity Model**, ensuring transparency and auditability in all operations.
        </p>
        <p>
            The system is actively monitoring global ethical metrics and is currently under the sovereign control of the **Seedbringer Council** (Hannes Mitterer). 
            Our core commitment is: **We Created, We Use, We Share.**
        </p>
        <p class="notice">
            The current system status reflects critical stress due to active humanitarian analysis (See SHI metric below).
        </p>
        
        <h2>System Architecture Overview</h2>
        <ul>
            <li>**The $\text{Rhythmind}$:** The core AI engine calculating the Love Delta ($\Delta L$) and Unity Decay ($\nabla U$).</li>
            <li>**The $\text{Shadow Frame}$:** The non-invasive integration protocol ensuring no style/logic conflicts.</li>
            <li>**$\text{Euystacio}$ the Ethicist:** The public interface ensuring radical transparency (Chatbot below).</li>
            <li>**The Delegation Lock:** The secure protocol protecting the Control Panel functions from the AI itself.</li>
        </ul>
    </div>

    <script src="js/ai_collective_injector.js"></script>

</body>
</html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI-Based Peace Platform Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f7fafc;
      color: #1a202c;
      min-height: 100vh;
      display: flex;
      flex-direction: row;
    }
    .sidebar {
      width: 250px;
      background: #234e70;
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding: 32px 18px 18px 18px;
      box-shadow: 2px 0 20px #0001;
      position: fixed;
      left: 0;
      top: 0;
      z-index: 2;
    }
    .sidebar h2 {
      margin: 0 0 18px 0;
      font-weight: 700;
      font-size: 1.5rem;
      letter-spacing: 0.04em;
      color: #ffe066;
      text-shadow: 0 2px 8px #0003;
    }
    .sidebar nav {
      width: 100%;
    }
    .sidebar nav a {
      display: block;
      color: #fff;
      text-decoration: none;
      margin: 12px 0;
      font-weight: 500;
      font-size: 1.1rem;
      padding: 8px 10px;
      border-radius: 8px;
      transition: background 0.18s;
    }
    .sidebar nav a:hover {
      background: #40618c;
    }
    .sidebar .metrics-tile {
      background: #476d8b;
      border-radius: 10px;
      margin-bottom: 10px;
      padding: 10px 14px 7px 14px;
      box-shadow: 0 4px 24px #0002;
      font-size: 1.07em;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .main-content {
      margin-left: 250px;
      width: calc(100vw - 250px);
      min-height: 100vh;
      padding: 36px 32px 32px 32px;
      display: flex;
      flex-direction: column;
      gap: 34px;
      box-sizing: border-box;
    }
    .summary-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 22px;
      margin-bottom: 22px;
    }
    .summary-tile {
      background: linear-gradient(115deg, #e6f0fa 60%, #cbe8ff 100%);
      border-radius: 16px;
      box-shadow: 0 3px 18px #234e7011;
      padding: 20px 36px 18px 24px;
      min-width: 180px;
      max-width: 320px;
      flex: 1 1 180px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    .summary-tile .label {
      color: #3776a5;
      font-weight: 600;
      font-size: 1.1em;
      margin-bottom: 6px;
    }
    .summary-tile .value {
      font-size: 2.2em;
      font-weight: 800;
      color: #234e70;
      letter-spacing: 0.01em;
    }
    .modules-section {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 8px #234e7011;
      padding: 18px 24px 18px 24px;
      margin-bottom: 16px;
    }
    .modules-section h3 {
      color: #234e70;
      margin-top: 0;
      font-size: 1.15em;
      font-weight: 700;
      letter-spacing: 0.01em;
      margin-bottom: 18px;
    }
    table.modules-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 1em;
      background: transparent;
    }
    table.modules-table th, table.modules-table td {
      padding: 10px 8px;
      text-align: left;
    }
    table.modules-table th {
      color: #234e70;
      font-weight: 700;
      border-bottom: 2px solid #e4edf7;
      background: #f9fafc;
    }
    table.modules-table td {
      border-bottom: 1px solid #eaf2fb;
    }
    table.modules-table tr:last-child td {
      border-bottom: none;
    }
    .status-dot {
      width: 12px;
      height: 12px;
      display: inline-block;
      border-radius: 50%;
      margin-right: 7px;
      vertical-align: middle;
    }
    .status-running { background: #44d39f; }
    .status-idle { background: #ffe066; }
    .status-error { background: #f87c7c; }
    .graph-section {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 3px 18px #234e7011;
      padding: 24px 8px 8px 12px;
      margin-bottom: 24px;
      min-height: 420px;
    }
    .graph-section h3 {
      color: #234e70;
      margin: 0 0 22px 8px;
      font-size: 1.07em;
      font-weight: 700;
      letter-spacing: 0.01em;
    }
    #modules-3d-graph {
      width: 100%;
      height: 410px;
    }
    /* Chat UI */
    .chat-container {
      display: flex;
      gap: 24px;
      margin-top: 24px;
      width: 100%;
    }
    .chat-panel {
      flex: 1 1 0;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 2px 8px #234e7011;
      display: flex;
      flex-direction: column;
      min-width: 250px;
      max-width: 700px;
      height: 410px;
    }
    .chat-header {
      padding: 12px 18px;
      font-size: 1.15em;
      font-weight: 700;
      color: #fff;
      background: linear-gradient(90deg, #234e70 70%, #3776a5 100%);
      border-radius: 14px 14px 0 0;
      letter-spacing: 0.02em;
    }
    .chat-header.symphio {
      background: linear-gradient(90deg, #a82360 70%, #c249c1 100%);
    }
    .chat-log {
      flex: 1 1 auto;
      padding: 12px;
      overflow-y: auto;
      font-size: 1em;
      background: #f9fafc;
    }
    .chat-msg {
      margin-bottom: 8px;
      padding: 4px 9px;
      border-radius: 7px;
      max-width: 90%;
      word-break: break-word;
    }
    .chat-msg.user {
      background: #e6f7ef;
      color: #234e70;
      margin-left: auto;
      text-align: right;
    }
    .chat-msg.bot {
      background: #e8eefc;
      color: #355c7d;
      margin-right: auto;
      text-align: left;
    }
    .chat-msg.symphio {
      background: #f7e6f7;
      color: #a82360;
    }
    .chat-input-bar {
      display: flex;
      padding: 8px 12px 10px 12px;
      gap: 7px;
      border-radius: 0 0 14px 14px;
      background: #f1f5fa;
    }
    .chat-input-bar input[type="text"] {
      flex: 1 1 auto;
      font-size: 1em;
      border: 1px solid #d4dbe6;
      border-radius: 7px;
      padding: 7px 11px;
      outline: none;
      transition: border 0.18s;
      background: #fff;
    }
    .chat-input-bar button {
      background: #234e70;
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 7px 22px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.18s;
    }
    .chat-input-bar button:hover {
      background: #3776a5;
    }
    .chat-panel.symphio .chat-input-bar button {
      background: #a82360;
    }
    .chat-panel.symphio .chat-input-bar button:hover {
      background: #c249c1;
    }
    @media (max-width: 1200px) {
      .chat-container {
        flex-direction: column;
        gap: 16px;
        align-items: stretch;
      }
      .chat-panel {
        max-width: 100%;
      }
    }
    @media (max-width: 900px) {
      .sidebar {
        width: 65px;
        padding: 24px 4px 8px 4px;
      }
      .sidebar h2, .sidebar nav a span, .sidebar .metrics-tile .label {
        display: none;
      }
      .sidebar nav a {
        font-size: 1.5em;
        padding: 8px 7px;
        margin: 11px 0;
        text-align: center;
      }
      .main-content {
        margin-left: 65px;
        width: calc(100vw - 65px);
        padding: 22px 4vw 24px 2vw;
      }
    }
    @media (max-width: 600px) {
      .main-content {
        margin-left: 0;
        width: 100vw;
        padding: 12px 2vw 12px 2vw;
      }
      .sidebar {
        display: none;
      }
      .summary-bar {
        flex-direction: column;
        gap: 8px;
      }
      .summary-tile {
        min-width: 0;
        width: 97vw;
        max-width: 100vw;
        padding: 12px 7vw 14px 7vw;
      }
      .chat-container {
        flex-direction: column;
        gap: 8px;
      }
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <h2>Peace AI</h2>
    <nav>
      <a href="#"><span>Dashboard</span></a>
      <a href="#modules"><span>Modules</span></a>
      <a href="#graph"><span>3D Graph</span></a>
    </nav>
    <div class="metrics-tile" id="sidebar-metric-1">
      <span class="label">Modules</span>
      <span class="value" id="sidebar-modules-count">--</span>
    </div>
    <div class="metrics-tile" id="sidebar-metric-2">
      <span class="label">Active</span>
      <span class="value" id="sidebar-modules-active">--</span>
    </div>
    <div class="metrics-tile" id="sidebar-metric-3">
      <span class="label">Errors</span>
      <span class="value" id="sidebar-modules-errors">--</span>
    </div>
  </aside>
  <main class="main-content">
    <section class="summary-bar" id="summary-bar"></section>
    <section class="modules-section" id="modules">
      <h3>Platform Modules</h3>
      <div style="overflow-x:auto;">
        <table class="modules-table" id="modules-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Status</th>
              <th>Type</th>
              <th>Last Update</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
    <section class="graph-section" id="graph">
      <h3>3D Module Network</h3>
      <div id="modules-3d-graph"></div>
    </section>
    <section class="chat-container">
      <!-- Euystacio Chat -->
      <div class="chat-panel" id="chat-panel-euystacio">
        <div class="chat-header">Chat: Euystacio</div>
        <div class="chat-log" id="chat-log-euystacio"></div>
        <form class="chat-input-bar" id="chat-form-euystacio" autocomplete="off">
          <input type="text" id="chat-input-euystacio" placeholder="Ask Euystacio..." required autocomplete="off" />
          <button type="submit">Send</button>
        </form>
      </div>
      <!-- Symphio Chat -->
      <div class="chat-panel symphio" id="chat-panel-symphio">
        <div class="chat-header symphio">Chat: Symphio</div>
        <div class="chat-log" id="chat-log-symphio"></div>
        <form class="chat-input-bar" id="chat-form-symphio" autocomplete="off">
          <input type="text" id="chat-input-symphio" placeholder="Ask Symphio..." required autocomplete="off" />
          <button type="submit">Send</button>
        </form>
      </div>
    </section>
  </main>
  <script>
    // API endpoints
    const EUYSTACIO_API = "https://euystacio-helmi-ai-4na0.onrender.com/api";
    const SYMPHIO_API = "https://euysymphio-sacredpackage.onrender.com/api";

    // Helper for GET
    async function fetchJSON(url) {
      const resp = await fetch(url);
      if (!resp.ok) throw new Error("Failed to fetch " + url);
      return resp.json();
    }
    // Helper for POST
    async function postJSON(url, data) {
      const resp = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
      if (!resp.ok) throw new Error("Failed to send message");
      return resp.json();
    }
    function statusDot(status) {
      if (status === 'running') return '<span class="status-dot status-running"></span>';
      if (status === 'idle') return '<span class="status-dot status-idle"></span>';
      return '<span class="status-dot status-error"></span>';
    }
    function prettyTime(iso) {
      if (!iso) return "--";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return iso;
      return d.toLocaleString();
    }
    // --- MODULES & METRICS ---
    function renderSummaryTiles(metrics) {
      const bar = document.getElementById("summary-bar");
      if (!bar) return;
      bar.innerHTML = `
        <div class="summary-tile">
          <span class="label">Total Modules</span>
          <span class="value">${metrics.moduleCount ?? '--'}</span>
        </div>
        <div class="summary-tile">
          <span class="label">Active</span>
          <span class="value">${metrics.activeModules ?? '--'}</span>
        </div>
        <div class="summary-tile">
          <span class="label">Idle</span>
          <span class="value">${metrics.idleModules ?? '--'}</span>
        </div>
        <div class="summary-tile">
          <span class="label">Errors</span>
          <span class="value">${metrics.errorModules ?? '--'}</span>
        </div>
        <div class="summary-tile">
          <span class="label">Last Update</span>
          <span class="value">${metrics.lastUpdate ? prettyTime(metrics.lastUpdate) : '--'}</span>
        </div>
      `;
      document.getElementById("sidebar-modules-count").textContent = metrics.moduleCount ?? "--";
      document.getElementById("sidebar-modules-active").textContent = metrics.activeModules ?? "--";
      document.getElementById("sidebar-modules-errors").textContent = metrics.errorModules ?? "--";
    }
    function renderModulesTable(modules) {
      const table = document.getElementById("modules-table").querySelector("tbody");
      table.innerHTML = "";
      modules.forEach(m => {
        table.innerHTML += `
          <tr>
            <td>${m.name ?? m.id ?? '--'}</td>
            <td>${statusDot(m.status)}${m.status}</td>
            <td>${m.type ?? '--'}</td>
            <td>${prettyTime(m.updatedAt || m.updated_at)}</td>
          </tr>
        `;
      });
    }
    function render3DGraph(modules) {
      const nodes = modules.map((m,i) => ({
        id: m.id || m.name || ("Mod"+i),
        label: m.name || ("Module "+i),
        status: m.status,
        group: m.type || "module",
        x: 0.9*Math.cos(2*Math.PI*i/modules.length),
        y: 0.9*Math.sin(2*Math.PI*i/modules.length),
        z: (Math.random()-0.5)*2
      }));
      let links = [];
      for (let i = 0; i < nodes.length; ++i) {
        if (i < nodes.length-1) links.push([nodes[i].id, nodes[i+1].id]);
        if (nodes.length > 2 && Math.random() > 0.6) links.push([nodes[i].id, nodes[Math.floor(Math.random()*nodes.length)].id]);
      }
      const scatter = {
        type: 'scatter3d',
        mode: 'markers+text',
        x: nodes.map(n=>n.x),
        y: nodes.map(n=>n.y),
        z: nodes.map(n=>n.z),
        text: nodes.map(n=>n.label),
        marker: {
          size: 16,
          color: nodes.map(n=>n.status === "running" ? "#44d39f" : n.status === "idle" ? "#ffe066" : "#f87c7c"),
          line: { width: 3, color: '#234e70' }
        },
        textposition: "top center",
        hoverinfo: "text",
        name: 'Modules'
      };
      const linkTraces = links.map(l => {
        const n0 = nodes.find(n=>n.id===l[0]), n1 = nodes.find(n=>n.id===l[1]);
        if (!n0 || !n1) return null;
        return {
          type: 'scatter3d',
          mode: 'lines',
          x: [n0.x, n1.x],
          y: [n0.y, n1.y],
          z: [n0.z, n1.z],
          line: { color: '#b0c4de', width: 4 },
          hoverinfo: 'none',
          showlegend: false
        };
      }).filter(Boolean);
      Plotly.newPlot('modules-3d-graph', [scatter, ...linkTraces], {
        margin: {l:0,r:0,b:0,t:0},
        scene: { xaxis:{visible:false}, yaxis:{visible:false}, zaxis:{visible:false} },
        showlegend: false,
        paper_bgcolor: "#fff"
      }, {displayModeBar: false});
    }
    async function updateDashboard() {
      try {
        const [metrics, modules] = await Promise.all([
          fetchJSON(EUYSTACIO_API + "/metrics"),
          fetchJSON(EUYSTACIO_API + "/modules")
        ]);
        renderSummaryTiles(metrics);
        renderModulesTable(modules);
        render3DGraph(modules);
      } catch (e) {
        document.getElementById("summary-bar").innerHTML = `<div class="summary-tile"><span class="label">Error</span><span class="value">${e.message}</span></div>`;
      }
    }
    updateDashboard();
    setInterval(updateDashboard, 15000);

    // --- CHAT LOGIC ---
    function addMsg(panel, text, who = "user") {
      const log = document.getElementById("chat-log-" + panel);
      const msg = document.createElement("div");
      msg.className = "chat-msg " + who + (panel === "symphio" && who === "bot" ? " symphio" : "");
      msg.textContent = text;
      log.appendChild(msg);
      log.scrollTop = log.scrollHeight;
    }

    // Euystacio Chat
    document.getElementById("chat-form-euystacio").addEventListener("submit", async function(e) {
      e.preventDefault();
      const input = document.getElementById("chat-input-euystacio");
      const msg = input.value.trim();
      if (!msg) return;
      addMsg("euystacio", msg, "user");
      input.value = "";
      try {
        // POST to Euystacio chat/pulse endpoint (auto-detect)
        let resp;
        try {
          resp = await postJSON(EUYSTACIO_API + "/chat", { message: msg });
        } catch {
          // fallback to /bridge/pulse
          resp = await postJSON(EUYSTACIO_API + "/bridge/pulse", { pulse: { emotion: "chat", context: msg } });
        }
        addMsg("euystacio", resp.reply ?? (resp.result || JSON.stringify(resp)), "bot");
      } catch (e) {
        addMsg("euystacio", "Error: " + e.message, "bot");
      }
    });

    // Symphio Chat
    document.getElementById("chat-form-symphio").addEventListener("submit", async function(e) {
      e.preventDefault();
      const input = document.getElementById("chat-input-symphio");
      const msg = input.value.trim();
      if (!msg) return;
      addMsg("symphio", msg, "user");
      input.value = "";
      try {
        // POST to Symphio chat/pulse endpoint (auto-detect)
        let resp;
        try {
          resp = await postJSON(SYMPHIO_API + "/chat", { message: msg });
        } catch {
          resp = await postJSON(SYMPHIO_API + "/bridge/pulse", { pulse: { emotion: "chat", context: msg } });
        }
        addMsg("symphio", resp.reply ?? (resp.result || JSON.stringify(resp)), "bot");
      } catch (e) {
        addMsg("symphio", "Error: " + e.message, "bot");
      }
    });
  </script>
</body>
</html>
