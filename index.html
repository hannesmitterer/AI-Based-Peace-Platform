<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Euystacio Pulse Dashboard</title>
    <style>
        body { margin: 0; height: 100vh; overflow: hidden; font-family: Arial, sans-serif; background: #f4f7f6; color: #222; }
        canvas { display: block; }
        #pulse-controls {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 10;
            background: rgba(255, 255, 255, 0.97);
            padding: 20px 18px 20px 18px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            min-width: 280px;
        }
        #pulse-controls label, #pulse-controls button, #pulse-controls select, #pulse-controls input {
            display: block;
            margin-bottom: 10px;
            font-size: 16px;
        }
        #pulse-controls input[type="range"] { width: 220px; }
        #pulse-controls button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 17px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: bold;
        }
        #pulse-controls button:hover { background-color: #0056b3; }
        #pulse-history {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10;
            background: rgba(255,255,255,0.97);
            border-radius: 10px;
            padding: 14px 18px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.10);
            min-width: 220px;
        }
        #pulse-list { list-style: none; padding-left: 0; font-size: 14px; }
        #pulse-list li { margin-bottom: 6px; }
        #kernel-state-display {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(255,255,255,0.97);
            border-radius: 8px;
            padding: 10px 16px;
            box-shadow: 0 2px 8px #bbb;
            font-size: 16px;
            min-width: 180px;
        }
        #tooltip {
            display:none;
            position:fixed;
            top:10px;
            left:50%;
            background:#fff;
            padding:10px;
            border-radius:7px;
            box-shadow:0 2px 8px #aaa;
            transform: translateX(-50%);
            z-index: 50;
        }
        .night-mode { background: #222 !important; color: #eee !important; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
    <div id="pulse-controls">
        <label for="emotion-intensity">Emotion Intensity (0-1):</label>
        <input type="range" id="emotion-intensity" min="0" max="1" step="0.01" value="0.5">
        <label for="emotion">Emotion:</label>
        <select id="emotion">
            <option value="anger">Anger</option>
            <option value="neutral">Neutral</option>
            <option value="calm">Calm</option>
        </select>
        <label for="context">Context:</label>
        <input type="text" id="context" placeholder="e.g., User Feedback">
        <button onclick="handlePulseSubmit()">Send Pulse</button>
        <button onclick="toggleNightMode()">Toggle Night Mode</button>
    </div>
    <div id="pulse-history">
        <h4>Your Pulse History</h4>
        <ul id="pulse-list"></ul>
    </div>
    <div id="kernel-state-display">
        <p>Trust: <span id="trust-value">0.0</span></p>
        <p>Harmony: <span id="harmony-value">0.0</span></p>
    </div>
    <div id="tooltip"><span id="tooltip-text"></span></div>
    <script>
        // --- 3D Visualization Setup ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Kernel Sphere
        const geometry = new THREE.SphereGeometry(5, 32, 32);
        const material = new THREE.MeshBasicMaterial({ color: 0x0077ff, transparent: true, opacity: 0.8 });
        const kernel = new THREE.Mesh(geometry, material);
        scene.add(kernel);

        // Lighting
        scene.add(new THREE.AmbientLight(0x404040));
        const dLight = new THREE.DirectionalLight(0xffffff, 0.5); dLight.position.set(0,1,1); scene.add(dLight);
        camera.position.z = 20;

        // --- API Integration ---
        function sendPulseToAPI(pulseData) {
            return fetch('/api/pulse', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(pulseData)
            }).then(res => res.json());
        }
        function fetchKernelStateFromAPI() {
            return fetch('/api/reflect').then(res => res.json());
        }

        // --- Pulse Animation ---
        function showPulseTrail(intensity) {
            const pulseSize = intensity * 3 + 0.5;
            const color = intensity > 0.7 ? 0xff0000 : (intensity > 0.3 ? 0xffff00 : 0x00ff00);
            const pulseGeometry = new THREE.SphereGeometry(pulseSize, 20, 20);
            const pulseMaterial = new THREE.MeshBasicMaterial({ color, transparent: true, opacity: 0.7 });
            const pulseObject = new THREE.Mesh(pulseGeometry, pulseMaterial);
            scene.add(pulseObject);
            let scale = 1;
            const scaleInterval = setInterval(() => {
                if (scale < 15) {
                    pulseObject.scale.set(scale, scale, scale);
                    pulseObject.material.opacity = Math.max(0.1, 0.7 - (scale / 20));
                    scale += 0.5;
                } else {
                    clearInterval(scaleInterval);
                    scene.remove(pulseObject);
                }
            }, 50);
        }

        // --- Kernel Dynamic Updates ---
        function updateKernelVisualization(state) {
            // Color by trust, scale by trust, rotate by harmony
            kernel.material.color.set(state.trust > 0.5 ? 0x00ff00 : 0xff0000);
            kernel.scale.set(state.trust * 2, state.trust * 2, state.trust * 2);
            kernel.rotation.x += state.harmony * 0.1;
        }

        // --- UX/UI Feedback ---
        function updateKernelValuesDisplay(state) {
            document.getElementById('trust-value').textContent = state.trust.toFixed(2);
            document.getElementById('harmony-value').textContent = state.harmony.toFixed(2);
        }
        function showTooltip(message) {
            const tooltip = document.getElementById('tooltip');
            document.getElementById('tooltip-text').textContent = message;
            tooltip.style.display = 'block';
            setTimeout(() => { tooltip.style.display = 'none'; }, 2000);
        }
        function toggleNightMode() {
            document.body.classList.toggle('night-mode');
        }

        // --- Pulse History ---
        function addPulseToHistory(pulseData) {
            const pulseList = document.getElementById('pulse-list');
            const newItem = document.createElement('li');
            newItem.textContent = `Intensity: ${pulseData.intensity}, Emotion: ${pulseData.emotion}, Context: ${pulseData.context}`;
            pulseList.appendChild(newItem);
        }

        // --- Pulse Submission Handler ---
        function handlePulseSubmit() {
            const intensity = parseFloat(document.getElementById('emotion-intensity').value);
            const emotion = document.getElementById('emotion').value;
            const context = document.getElementById('context').value || 'user-feedback';
            const pulseData = { intensity, emotion, context };
            showPulseTrail(intensity);
            sendPulseToAPI(pulseData)
                .then((resp) => {
                    addPulseToHistory(pulseData);
                    updateKernelStateOnFrontend();
                    showTooltip(`Pulse sent! Kernel updated.`);
                })
                .catch(() => showTooltip('Error sending pulse.'));
        }

        // --- Kernel State Updater ---
        function updateKernelStateOnFrontend() {
            fetchKernelStateFromAPI()
                .then(state => {
                    updateKernelVisualization(state);
                    updateKernelValuesDisplay(state);
                    showTooltip(`Trust: ${state.trust.toFixed(2)}, Harmony: ${state.harmony.toFixed(2)}`);
                })
                .catch(() => showTooltip('Error fetching kernel state.'));
        }

        // --- Initial Kernel State ---
        updateKernelStateOnFrontend();

        // --- Render Loop ---
        function animate() {
            requestAnimationFrame(animate);
            kernel.rotation.x += 0.005;
            kernel.rotation.y += 0.005;
            renderer.render(scene, camera);
        }
        animate();
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>